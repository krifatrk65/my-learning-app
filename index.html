<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Series - Ad-Supported Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo-600 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate-900 */
            color: #f1f5f9; /* Slate-100 */
        }
        .custom-select {
            background-color: #1e293b; /* Slate-800 */
            color: #f1f5f9; /* Slate-100 */
            border: 1px solid #334155; /* Slate-700 */
        }
        .custom-select:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 1px #4f46e5;
        }
        .ad-timer-glow {
            animation: pulse-glow 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 204, 0, 0.4); }
            50% { box-shadow: 0 0 15px 5px rgba(255, 204, 0, 0.8); }
        }
        /* Custom styling for radio buttons to look like tabs */
        .payment-radio-label {
            @apply flex-1 py-3 px-4 text-center cursor-pointer rounded-lg font-semibold transition duration-200;
            @apply bg-slate-700 text-slate-300 hover:bg-slate-600;
        }
        input[name="paymentMethod"]:checked + .payment-radio-label {
            @apply bg-pink-600 text-white shadow-lg shadow-pink-500/30;
        }

        /* --- Custom Modal Styling --- */
        .modal {
            @apply fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center transition-opacity duration-300 ease-out;
        }
        .modal-content {
            @apply bg-slate-800 p-8 rounded-xl shadow-2xl border-t-4 border-indigo-500 max-w-sm w-full;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Global State and Data -->
    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, getDocs, collection, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARIABLES (Provided by Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'guest'; // Default user ID
        let firestoreDocRef;
        let isAuthReady = false;

        // --- MOCK COURSE DATA (Kept the same) ---
        const MOCK_COURSES = {
            'CBSE': {
                'Class VII': {
                    'Physics': {
                        'Chapter 1: Heat': [
                            { id: 1, title: '1. Temperature and Measurement (Free)', duration: '10:00', free: true },
                            { id: 2, title: '2. Transfer of Heat', duration: '15:00', free: false },
                        ],
                    },
                },
                'Class IX': {
                    'Physics': {
                        'Chapter 1: Motion': [
                            { id: 1, title: '1. Kinematics Basics', duration: '12:30', free: true },
                            { id: 2, title: '2. Equations of Motion', duration: '08:45', free: false },
                            { id: 3, title: '3. Graphs and Analysis', duration: '25:10', free: false },
                        ],
                    },
                },
                'Class X': {
                    'Physics': {
                        'Chapter 1: Electricity': [
                            { id: 1, title: '1. Electric Charge and Current (Free)', duration: '15:00', free: true },
                            { id: 2, title: '2. Ohm\'s Law and Resistance', duration: '22:00', free: false },
                        ],
                    },
                },
                'Class XI': {
                    'Physics': {
                        'Chapter 1: Kinematics': [
                            { id: 1, title: '1. Displacement and Velocity (Free)', duration: '18:00', free: true },
                            { id: 2, title: '2. Projectile Motion', duration: '25:00', free: false },
                        ],
                    },
                },
                'Class XII': {
                    'Physics': { 
                        'Chapter 1: Electrostatics': [
                            { id: 1, title: '1. Coulomb\'s Law (Free)', duration: '20:00', free: true },
                            { id: 2, title: '2. Electric Field Intensity', duration: '28:00', free: false },
                        ],
                    },
                },
            },
            'ICSE': {
                'Class X': {
                    'Biology': {
                        'Chapter 1: Cell': [
                            { id: 1, title: '1. Cell Structure (Free)', duration: '11:00', free: true },
                            { id: 2, title: '2. Cell Division', duration: '18:00', free: false },
                        ],
                    },
                },
            },
        };

        // --- AUTHENTICATION STATE (Now managed by Firestore) ---
        let authState = {
            isLoggedIn: false,
            freeMinutes: 0, 
            isPremium: false,
            email: null
        };
        
        // --- UI/VIEW STATE (Kept the same) ---
        let currentView = 'lecture'; 
        let selection = {
            board: 'CBSE',
            class: 'Class IX', 
            subject: 'Physics',
            chapter: 'Chapter 1: Motion',
            lectureIndex: 0 
        };
        let selectedPaymentMethod = 'Card';
        
        // --- EXPOSE FUNCTIONS TO GLOBAL SCOPE FOR INLINE HTML EVENTS ---
        window.closeModal = closeModal;
        window.showView = showView;
        window.handleSelectionChange = handleSelectionChange;
        window.startAdWatch = startAdWatch;
        window.handlePostAdChoice = handlePostAdChoice;
        window.handleAdRepeatChoice = handleAdRepeatChoice;
        window.handleNextLecture = handleNextLecture;
        window.handleLoginSubmit = handleLoginSubmit;
        window.handleSubscribe = handleSubscribe;
        window.updatePaymentInputs = updatePaymentInputs;
        window.handleAuthButtonClick = handleAuthButtonClick; 

        // --- FIREBASE INITIALIZATION AND AUTH ---
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Data persistence will not work.");
                    isAuthReady = true;
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);

                // We intentionally ignore `__initial_auth_token` here to force the app to start
                // in the unauthenticated state so the user can interact with the login gate.
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            // User logged in via session persistence (after a successful login)
                            userId = user.uid;
                            authState.isLoggedIn = true;
                        } else {
                            // No user in session. Start unauthenticated.
                            userId = crypto.randomUUID(); 
                            authState.isLoggedIn = false;
                        }

                        // Only set up Firestore data listener if the user is explicitly logged in
                        if (authState.isLoggedIn) {
                             firestoreDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'ad_data');
                             setupDataListener(); 
                        } else {
                            // If unauthenticated, ensure state is clean and ready to render
                            authState.freeMinutes = 0;
                            authState.isPremium = false;
                            isAuthReady = true; 
                            updateLectureDisplay();
                            showView('lecture'); // Immediately show the lecture view (unauthenticated)
                        }
                        
                        isAuthReady = true;
                        updateMinutesDisplay();
                        resolve();
                        unsubscribe(); 
                    });
                });
            } catch (error) {
                console.error("Error during Firebase initialization or sign-in:", error);
                isAuthReady = true;
                showView('lecture'); // Fallback to lecture view if initialization fails
            }
        }

        // --- FIRESTORE DATA HANDLING ---

        function setupDataListener() {
            if (!db || !firestoreDocRef) return;
            
            // Listen for real-time changes to the user's ad data
            onSnapshot(firestoreDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    authState.freeMinutes = data.freeMinutes || 0;
                    authState.isPremium = data.isPremium || false;
                    authState.isLoggedIn = true; 
                    authState.email = data.email || null;
                    console.log(`Data loaded: Minutes=${authState.freeMinutes}, Premium=${authState.isPremium}`);
                } else {
                    // Document doesn't exist, create initial state
                    saveUserState({ freeMinutes: 0, isPremium: false, email: authState.email || null });
                }
                updateMinutesDisplay();
                updateLectureDisplay();
                
                if (currentView === 'loading' || currentView === 'gate' || currentView === 'login-form') {
                    showView('lecture');
                }
            }, (error) => {
                console.error("Firestore snapshot error:", error);
            });
        }
        
        // Saves the current authState to Firestore
        async function saveUserState(updates = {}) {
            if (!firestoreDocRef || !authState.isLoggedIn) {
                 console.warn("Attempted to save user state but user is not logged in.");
                 return;
            }
            try {
                const dataToSave = {
                    freeMinutes: authState.freeMinutes,
                    isPremium: authState.isPremium,
                    email: authState.email || null, 
                    lastUpdated: new Date().toISOString(),
                    ...updates
                };
                
                await setDoc(firestoreDocRef, dataToSave, { merge: true });
            } catch (error) {
                console.error("Error saving state to Firestore:", error);
                alertMessage("Save Error", "Could not save your progress. Check your connection.");
            }
        }

        // --- Utility Functions (Modified for Firebase) ---

        function getCurrentLectureSeries() {
            const { board, class: className, subject, chapter } = selection;
            return MOCK_COURSES[board]?.[className]?.[subject]?.[chapter] || [];
        }

        function getCurrentLecture() {
            const series = getCurrentLectureSeries();
            return series[selection.lectureIndex] || null;
        }

        const getContainer = (id) => document.getElementById(id);

        // Custom alert function (as per constraints)
        function alertMessage(title, message, isError = false) {
            const modal = getContainer('custom-modal');
            const modalTitle = getContainer('modal-title');
            const modalMessage = getContainer('modal-message');

            if (modal && modalTitle && modalMessage) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modal.classList.remove('hidden');
            } else {
                console.warn(`[Mock Alert] ${title}: ${message}`);
            }
        }

        function closeModal() {
            const modal = getContainer('custom-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Function to switch the main view
        function showView(viewName) {
            currentView = viewName;
            document.querySelectorAll('main > div[id$="-container"]').forEach(el => {
                el.classList.add('hidden');
            });

            const container = getContainer(viewName + '-container');
            if (container) {
                container.classList.remove('hidden');
            }
            
            if (viewName === 'ad-repeat-prompt') {
                const minutesSpan = getContainer('ad-repeat-minutes');
                if (minutesSpan) {
                    minutesSpan.textContent = authState.freeMinutes;
                }
            }
            
            updateMinutesDisplay(); 
        }
        
        // Function called by the header button's onclick (FIXED FOR CLARITY)
        function handleAuthButtonClick() {
            if (!isAuthReady) {
                showView('loading');
                return;
            }
            
            let targetView;
            if (authState.isLoggedIn) {
                targetView = 'ad-menu';
                console.log('Auth Button Clicked: User is logged in, routing to Ad Menu.');
            } else {
                targetView = 'login-form';
                console.log('Auth Button Clicked: User is not logged in, routing to Login Form.');
            }

            showView(targetView);
        }

        // Updates the minutes display and header button state
        function updateMinutesDisplay() {
            const minutesElement = getContainer('free-minutes-display');
            if (minutesElement) {
                minutesElement.textContent = authState.freeMinutes;
            }
            
            const statusElement = getContainer('auth-status');
             if (statusElement) {
                // Only show a status if the user is authenticated or premium
                if (authState.isPremium) {
                    statusElement.innerHTML = `<span class="px-3 py-1 text-sm font-semibold rounded-full bg-emerald-600 text-white">Premium (Ad-Free)</span>`;
                } else if (authState.isLoggedIn) {
                    statusElement.innerHTML = `<span class="px-3 py-1 text-sm font-semibold rounded-full bg-yellow-600 text-slate-900 ad-timer-glow">Free Access: ${authState.freeMinutes} min</span>`;
                } else {
                    // Show nothing if not explicitly logged in/premium
                    statusElement.innerHTML = ``; 
                }
            }
            
            const loginButton = getContainer('login-signup-button');
            if (loginButton) {
                // Hide the button if they are Premium and logged in 
                if (authState.isLoggedIn && authState.isPremium) {
                    loginButton.classList.add('hidden');
                } else {
                    loginButton.classList.remove('hidden');
                    // Changed text to reflect the required action
                    loginButton.textContent = authState.isLoggedIn ? 'Manage Access' : 'Log in / Sign up';
                }
            }
        }

        // --- Auth and Gating Logic ---

        // Called on mock form submission (MOCK: just updates the state and saves to Firestore)
        async function handleLoginSubmit(event) {
            event.preventDefault();
            const email = getContainer('email').value;
            // In a real app, this would perform actual email/password authentication.
            
            // MOCK LOGIN SUCCESS:
            // This mocks the state change that would happen after a successful login/signup
            
            // MOCK: Sign in with the provided initial token now, or sign in anonymously if no token exists.
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback if environment token isn't provided (unlikely in Canvas)
                    // If signInWithCustomToken is used, auth.currentUser will have a uid.
                }
                
                // After successful (mocked) sign-in/auth update:
                userId = auth.currentUser?.uid || crypto.randomUUID();
                authState.isLoggedIn = true; 
            } catch (e) {
                console.error("Mock sign-in error during form submission:", e);
                alertMessage("Login Failed", "Could not complete sign-in. Please try again.");
                return;
            }
            
            authState.email = email;
            authState.freeMinutes = Math.max(authState.freeMinutes, 10); // Guarantee at least 10 min
            
            // Re-initialize firestoreDocRef with the new, persistent user
            firestoreDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'ad_data');
            
            // Save the new logged-in state to the database
            await saveUserState({ isLoggedIn: true, email: email, freeMinutes: authState.freeMinutes });
            
            // Set up listener for real-time updates after mock login
            setupDataListener();

            alertMessage("Welcome Back!", `Logged in as ${email}. Your progress has been loaded.`);
            // FIX: Route back to the main lecture view after login, so the "Manage Access" button has a clear action.
            showView('lecture');
        }

        function handleNextLecture() {
            const nextIndex = selection.lectureIndex + 1;
            const series = getCurrentLectureSeries();

            if (nextIndex >= series.length) {
                return;
            }

            handleLectureSelection(nextIndex);
        }

        // Core logic for selecting any lecture
        function handleLectureSelection(index) {
            if (!isAuthReady) {
                showView('loading');
                return;
            }
            
            const series = getCurrentLectureSeries();
            const newLecture = series[index];
            
            if (!newLecture) return;

            if (newLecture.free) {
                selection.lectureIndex = index;
                renderDropdowns();
                updateLectureDisplay();
                showView('lecture');
                return;
            }

            // --- LOCKED LECTURE LOGIC ---
            
            if (authState.isPremium) {
                selection.lectureIndex = index;
                renderDropdowns();
                updateLectureDisplay();
                showView('lecture');
            } else if (!authState.isLoggedIn) {
                // If not logged in and lecture is locked, go to the gate
                showView('gate');
            } else if (authState.freeMinutes > 0) {
                // Logged in, time available: consume 1 minute and play
                authState.freeMinutes -= 1;
                saveUserState({ freeMinutes: authState.freeMinutes }); 
                
                selection.lectureIndex = index;
                renderDropdowns();
                updateLectureDisplay();
                showView('lecture');
            } else {
                // Logged in, no time available: go to ad menu
                showView('ad-menu');
            }
            updateMinutesDisplay();
        }

        // --- Ad Workflow Functions ---

        // Start the ad simulation
        function startAdWatch() {
            showView('ad-watching');
            const adDuration = 5000; // 5 seconds mock ad
            const progressBar = getContainer('ad-progress-bar');
            
            progressBar.style.width = '0%';
            
            let start = null;
            function step(timestamp) {
                if (!start) start = timestamp;
                const progress = timestamp - start;
                const percentage = Math.min(100, (progress / adDuration) * 100);
                progressBar.style.width = percentage + '%';
                
                if (progress < adDuration) {
                    window.requestAnimationFrame(step);
                } else {
                    handleAdComplete();
                }
            }
            window.requestAnimationFrame(step);
        }

        // Handle minutes reward and transition to first prompt
        function handleAdComplete() {
            const minutesEarned = 15;
            authState.freeMinutes += minutesEarned;
            
            // --- SAVE NEW MINUTES TO FIRESTORE ---
            saveUserState({ freeMinutes: authState.freeMinutes }); 
            
            updateMinutesDisplay();
            alertMessage("Success!", `You earned ${minutesEarned} minutes! Total time: ${authState.freeMinutes} min.`);
            showView('ad-workflow-prompt');
        }

        // Handles the post-ad choice (Subscribe/Continue)
        function handlePostAdChoice(action) {
            if (action === 'subscribe') {
                showView('payment-portal');
            } else {
                showView('ad-repeat-prompt');
            }
        }
        
        // Handles the ad repeat choice (YES/NO)
        function handleAdRepeatChoice(wantsAd) {
            if (wantsAd) {
                startAdWatch(); 
            } else {
                showView('ad-menu');
            }
        }
        
        // Mock subscription completion
        async function handleSubscribe() {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value || 'Card';
            
            authState.isPremium = true;
            authState.isLoggedIn = true; 
            authState.freeMinutes = 99999; 
            
            // --- SAVE PREMIUM STATUS TO FIRESTORE ---
            await saveUserState({ isPremium: true, freeMinutes: authState.freeMinutes });

            alertMessage('Subscription Successful!', `Subscription processed using ${selectedMethod}. You now have ad-free, unlimited access.`);
            showView('lecture');
        }

        // Function to update the payment portal UI based on the selected method
        function updatePaymentInputs() {
            const selected = document.querySelector('input[name="paymentMethod"]:checked')?.value || 'Card';
            const cardInput = getContainer('card-details');
            const upiInput = getContainer('upi-details');
            const netBankingInput = getContainer('netbanking-details');

            if (cardInput) cardInput.classList.toggle('hidden', selected !== 'Card');
            if (upiInput) upiInput.classList.toggle('hidden', selected !== 'UPI');
            if (netBankingInput) netBankingInput.classList.toggle('hidden', selected !== 'Net Banking');
        }


        // --- Dropdown and UI Rendering Logic (Unchanged) ---

        function handleSelectionChange(level, value) {
            let newSelection = { ...selection };

            switch (level) {
                case 'board':
                    newSelection = { board: value, class: null, subject: null, chapter: null, lectureIndex: 0 };
                    break;
                case 'class':
                    newSelection = { ...selection, class: value, subject: null, chapter: null, lectureIndex: 0 };
                    break;
                case 'subject':
                    newSelection = { ...selection, subject: value, chapter: null, lectureIndex: 0 };
                    break;
                case 'chapter':
                    newSelection = { ...selection, chapter: value, lectureIndex: 0 };
                    break;
                case 'lectureIndex':
                    handleLectureSelection(parseInt(value, 10)); // Use new selection handler
                    return; 
            }

            if (level === 'board') {
                const firstClass = Object.keys(MOCK_COURSES[newSelection.board] || {})[0];
                newSelection.class = firstClass || null;
                const firstSubject = Object.keys(MOCK_COURSES[newSelection.board]?.[newSelection.class] || {})[0];
                newSelection.subject = firstSubject || null;
                const firstChapter = Object.keys(MOCK_COURSES[newSelection.board]?.[newSelection.class]?.[newSelection.subject] || {})[0];
                newSelection.chapter = firstChapter || null;
            } else if (level === 'class') {
                const firstSubject = Object.keys(MOCK_COURSES[newSelection.board]?.[newSelection.class] || {})[0];
                newSelection.subject = firstSubject || null;
                const firstChapter = Object.keys(MOCK_COURSES[newSelection.board]?.[newSelection.class]?.[newSelection.subject] || {})[0];
                newSelection.chapter = firstChapter || null;
            } else if (level === 'subject') {
                const firstChapter = Object.keys(MOCK_COURSES[newSelection.board]?.[newSelection.class]?.[newSelection.subject] || {})[0];
                newSelection.chapter = firstChapter || null;
            }
            
            newSelection.lectureIndex = 0;

            selection = newSelection;
            renderDropdowns();
            updateLectureDisplay();
            showView('lecture');
        }

        function updateLectureDisplay() {
            const currentLecture = getCurrentLecture();
            const titleElement = document.getElementById('video-title');
            const videoElement = document.getElementById('mock-video-player');
            const nextButton = document.getElementById('next-lecture-button');
            
            const isSelectionComplete = selection.board && selection.class && selection.subject && selection.chapter;

            if (!isSelectionComplete || !currentLecture) {
                if (titleElement) titleElement.textContent = "Please select a complete lecture.";
                if (videoElement) videoElement.innerHTML = `
                    <div class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 text-white/50">
                        <svg class="w-16 h-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <span class="text-xl">Lecture Not Selected</span>
                    </div>
                `;
                document.getElementById('lecture-details-text').textContent = "Use the dropdowns above to select a Board, Class, Subject, Chapter, and Lecture.";
                if (nextButton) nextButton.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            }
            
            if (nextButton) nextButton.classList.remove('opacity-50', 'cursor-not-allowed');

            if (titleElement) titleElement.textContent = currentLecture.title;
            
            let message = '';
            if (currentLecture.free) {
                message = "This is the free introductory lecture for this chapter. Log in to continue the series!";
            } else if (authState.isPremium) {
                message = "You are a Premium user. Watching ad-free.";
            } else if (authState.isLoggedIn && authState.freeMinutes > 0) {
                 message = `Viewing locked content. 1 minute deducted from your ad-earned time. **Remaining: ${authState.freeMinutes} minutes.**`;
            } else if (authState.isLoggedIn && authState.freeMinutes === 0) {
                 message = "This lecture is locked. You need to earn time by watching an ad first.";
            } else {
                 message = "This lecture is locked. Log in to watch or earn time by watching ads.";
            }
            
            document.getElementById('lecture-details-text').innerHTML = message;


            if (videoElement) {
                 videoElement.innerHTML = `
                    <div class="absolute inset-0 flex items-center justify-center bg-black/80">
                        <svg class="w-16 h-16 text-white/50 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.26a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="ml-4 text-xl">Playing Lecture ${currentLecture.id} (${currentLecture.duration})</span>
                    </div>
                `;
            }
        }
        
        function renderDropdowns() {
            const container = document.getElementById('selector-container');
            if (!container) return;
            
            const { board, class: className, subject, chapter, lectureIndex } = selection;

            const boards = Object.keys(MOCK_COURSES);
            const classes = board ? Object.keys(MOCK_COURSES[board]?.[className] || {}) : [];
            const subjects = board && className ? Object.keys(MOCK_COURSES[board]?.[className] || {}) : [];
            const chapters = board && className && subject ? Object.keys(MOCK_COURSES[board]?.[className]?.[subject] || {}) : [];
            const lectures = getCurrentLectureSeries();

            container.innerHTML = `
                ${createSelect(boards, board, 'Board', 'board', true, 'Select Board')}
                ${createSelect(classes, className, 'Class', 'class', !!board, 'Select Class')}
                ${createSelect(subjects, subject, 'Subject', 'subject', !!className, 'Select Subject')}
                ${createSelect(chapters, chapter, 'Chapter', 'chapter', !!subject, 'Select Chapter')}
                ${createSelect(lectures, lectureIndex, 'Lecture', 'lectureIndex', !!chapter && lectures.length > 0, 'Select Lecture')}
            `;

            ['board', 'class', 'subject', 'chapter'].forEach(level => {
                const element = document.getElementById(level);
                if (element) {
                    element.onchange = (e) => handleSelectionChange(level, e.target.value);
                }
            });
            
            const lectureElement = document.getElementById('lectureIndex');
            if (lectureElement) {
                lectureElement.onchange = (e) => handleSelectionChange('lectureIndex', e.target.value);
            }
        }
        
        function createSelect(options, currentValue, label, id, isEnabled, placeholder) {
            const isDisabled = !isEnabled && id !== 'board';
            let optionTags = options.map((option, index) => {
                let value = option;
                let display = option;
                let lockedIndicator = '';
                let isCurrent = false;

                if (id === 'lectureIndex') {
                    value = index;
                    display = option.title;
                    const isLocked = !option.free;
                    if (isLocked && !authState.isPremium) {
                        lockedIndicator = ' (Locked)';
                    }
                    if (index === currentValue) {
                        isCurrent = true;
                    }
                } else if (value === currentValue) {
                    isCurrent = true;
                }
                
                const optionClass = (id === 'lectureIndex' && !options[index].free && !authState.isPremium) ? 'text-red-400' : 'text-slate-100';

                return `<option value="${value}" ${isCurrent ? 'selected' : ''} class="${optionClass}">
                            ${display}${lockedIndicator}
                        </option>`;
            }).join('');

            return `
                <div class="col-span-1">
                    <label for="${id}" class="block text-sm font-medium text-slate-300 mb-1">${label}</label>
                    <select id="${id}" class="w-full px-3 py-2 border rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 custom-select disabled:bg-slate-900 disabled:text-slate-500" ${isDisabled ? 'disabled' : ''}>
                        <option value="" disabled ${currentValue === null ? 'selected' : ''}>${placeholder}</option>
                        ${optionTags}
                    </select>
                </div>
            `;
        }

        // Initial setup on window load
        window.onload = function() {
            // Start the loading screen while Firebase initializes
            showView('loading'); 
            
            // Initialization steps
            initializeFirebase().then(() => {
                // The initializeFirebase function now handles calling showView('lecture') if not logged in.
                renderDropdowns();
                updateLectureDisplay();
                updateMinutesDisplay();
            });
        };
    </script>

    <!-- Custom Modal Structure -->
    <div id="custom-modal" class="modal hidden">
        <div class="modal-content text-center">
            <h3 id="modal-title" class="text-2xl font-bold text-white mb-3"></h3>
            <p id="modal-message" class="text-slate-300 mb-6"></p>
            <button onclick="closeModal()" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                OK
            </button>
        </div>
    </div>

    <!-- Header / Navbar -->
    <header class="bg-slate-950 shadow-lg p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-indigo-400">Course Viewer</h1>
            <div class="flex items-center space-x-4">
                <div id="auth-status">
                    <!-- Status updated by updateMinutesDisplay() (no 'Guest' status anymore) -->
                </div>
                <button id="login-signup-button" onclick="handleAuthButtonClick()" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md transition duration-150">
                    Log in / Sign up
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full flex flex-col gap-6">
        
        <!-- 0. Loading Container -->
        <div id="loading-container" class="space-y-6 hidden h-full flex items-center justify-center flex-grow">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500 mx-auto mb-4"></div>
                <p class="text-xl text-indigo-300">Connecting to database and loading user state...</p>
            </div>
        </div>

        <!-- DROPDOWN SELECTORS -->
        <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
            <h3 class="text-xl font-bold text-white mb-4 border-b border-slate-700 pb-2">Select Course</h3>
            <div id="selector-container" class="grid grid-cols-2 gap-4 md:grid-cols-5 md:gap-4">
                <!-- Dropdowns will be rendered here by JavaScript -->
            </div>
        </div>

        <!-- 1. Lecture Viewing Container -->
        <div id="lecture-container" class="space-y-6 hidden">
            <div class="relative bg-slate-800 aspect-video rounded-xl overflow-hidden shadow-2xl">
                <div id="mock-video-player" class="w-full h-full flex items-center justify-center">
                    <!-- Content updated by JS -->
                </div>
            </div>

            <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 id="video-title" class="text-3xl font-extrabold text-white mb-2"></h2>
                <p id="lecture-details-text" class="text-slate-400 mb-6"></p>
                
                <div class="flex justify-end">
                    <button id="next-lecture-button" onclick="handleNextLecture()" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-xl shadow-indigo-500/30">
                        Next Lecture &rarr;
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. Initial Login Gate Container (Pre-login) -->
        <div id="gate-container" class="space-y-6 hidden h-full flex items-center justify-center">
            <div class="bg-slate-800 p-10 md:p-16 rounded-xl shadow-2xl max-w-lg w-full text-center border-t-4 border-indigo-600">
                <svg class="w-16 h-16 text-indigo-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                <h2 class="text-3xl font-bold text-white mb-4">You've Hit the Access Wall!</h2>
                <p class="text-xl text-indigo-300 mb-6">
                    You must log in to access the full course content.
                </p>
                <button onclick="showView('login-form')" class="w-full px-6 py-3 bg-indigo-600 text-white font-bold text-lg rounded-lg hover:bg-indigo-700 transition duration-150 shadow-xl shadow-indigo-500/50">
                    Log in / Sign up Now
                </button>
                <button onclick="handleSelectionChange('lectureIndex', 0)" class="w-full mt-4 text-sm text-slate-400 hover:text-indigo-400 transition duration-150">
                    &larr; Go Back to Free Lecture
                </button>
            </div>
        </div>

        <!-- 3. Login/Signup Form Container -->
        <div id="login-form-container" class="space-y-6 hidden h-full flex items-center justify-center">
            <div class="bg-slate-800 p-10 md:p-16 rounded-xl shadow-2xl max-w-md w-full border-t-4 border-emerald-600">
                <h2 class="text-3xl font-bold text-white mb-6 text-center">Login / Sign Up</h2>
                <p class="text-lg text-slate-300 mb-8 text-center">
                    Sign up with your email or phone number to unlock ad-supported free access.
                </p>
                <form onsubmit="handleLoginSubmit(event)">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-slate-400 mb-2">Email Address</label>
                        <input type="email" id="email" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-white" placeholder="you@example.com" required>
                    </div>
                    <div class="mb-4">
                        <label for="phone" class="block text-sm font-medium text-slate-400 mb-2">Phone Number</label>
                        <input type="tel" id="phone" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-white" placeholder="e.g., +91 98765 43210" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-slate-400 mb-2">Password (Mock)</label>
                        <input type="password" id="password" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-white" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="w-full px-6 py-3 bg-emerald-600 text-white font-bold text-lg rounded-lg hover:bg-emerald-700 transition duration-150 shadow-lg shadow-emerald-500/30">
                        Log In & Unlock Access
                    </button>
                    <button type="button" onclick="handleSelectionChange('lectureIndex', 0)" class="w-full mt-4 text-sm text-slate-400 hover:text-indigo-400 transition duration-150">
                        &larr; Back to Free Lecture
                    </button>
                </form>
            </div>
        </div>
        
        <!-- 4. Ad Menu Container (Post-login, 0 Minutes) -->
        <div id="ad-menu-container" class="space-y-6 hidden h-full flex items-center justify-center">
            <div class="bg-slate-800 p-10 md:p-16 rounded-xl shadow-2xl max-w-lg w-full text-center border-t-4 border-yellow-500">
                <svg class="w-16 h-16 text-yellow-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h2 class="text-3xl font-bold text-white mb-2">Free Time Balance</h2>
                <p class="text-5xl font-extrabold text-yellow-400 mb-6">
                    <span id="free-minutes-display">0</span> min
                </p>
                <p class="text-lg text-slate-300 mb-8">
                    You need time to watch locked lectures. Each lecture deducts 1 minute.
                </p>
                <button onclick="startAdWatch()" class="w-full px-6 py-3 bg-yellow-600 text-slate-900 font-bold text-lg rounded-lg hover:bg-yellow-500 transition duration-150 shadow-xl shadow-yellow-500/50">
                    Watch an Ad to Earn Time (15 min)
                </button>
                <button onclick="showView('lecture')" class="w-full mt-4 text-sm text-slate-400 hover:text-indigo-400 transition duration-150">
                    &larr; Go Back to Lecture List
                </button>
            </div>
        </div>

        <!-- 5. Ad Watching Container (Ad Simulation) -->
        <div id="ad-watching-container" class="space-y-6 hidden h-full flex items-center justify-center">
            <div class="bg-slate-800 p-10 md:p-16 rounded-xl shadow-2xl max-w-lg w-full text-center border-t-4 border-red-500">
                <svg class="w-16 h-16 text-red-500 mx-auto mb-4 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                <h2 class="text-3xl font-bold text-white mb-4">Ad Playing... (5 Seconds)</h2>
                <p class="text-lg text-slate-300 mb-8">
                    Thank you for supporting the free education model! **15 minutes** of time will be added shortly.
                </p>
                <!-- Progress Bar -->
                <div class="w-full bg-slate-700 rounded-full h-2.5 mb-8">
                    <div id="ad-progress-bar" class="bg-red-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p class="text-sm text-red-400">DO NOT navigate away. Time will be added on completion.</p>
            </div>
        </div>
        
        <!-- 6. Post-Ad Prompt 1: Subscribe/Continue -->
        <div id="ad-workflow-prompt-container" class="space-y-6 hidden h-full flex items-center justify-center">
            <div class="bg-slate-800 p-10 md:p-16 rounded-xl shadow-2xl max-w-lg w-full text-center border-t-4 border-indigo-600">
                <svg class="w-16 h-16 text-indigo-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.242a2.24 2.24 0 012.72 4.242L12 17.25 3.662 9.992A2.24 2.24 0 016.382 5.75l5.378 4.673 1.09-1.25z"></path></svg>
                <h2 class="text-3xl font-bold text-white mb-4">Time Added!</h2>
                <p class="text-xl text-indigo-300 mb-6 font-bold">
                    Subscribe to go ad free!
                </p>
                <div class="space-y-4">
                    <button onclick="handlePostAdChoice('subscribe')" class="w-full px-6 py-3 bg-indigo-600 text-white font-bold text-lg rounded-lg hover:bg-indigo-700 transition duration-150 shadow-xl shadow-indigo-500/50">
                        Subscribe (Go Ad-Free)
                    </button>
                    <button onclick="handlePostAdChoice('continue')" class="w-full px-6 py-3 bg-slate-600 text-white font-bold text-lg rounded-lg hover:bg-slate-700 transition duration-150">
                        No, I will continue the free experience!
                    </button>
                </div>
            </div>
        </div>

        <!-- 7. Post-Ad Prompt 2: Ad Repeat -->
        <div id="ad-repeat-prompt-container" class="space-y-6 hidden h-full flex items-center justify-center">
            <div class="bg-slate-800 p-10 md:p-16 rounded-xl shadow-2xl max-w-lg w-full text-center border-t-4 border-yellow-500">
                <svg class="w-16 h-16 text-yellow-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                <h2 class="text-3xl font-bold text-white mb-4">Time Remaining: <span id="ad-repeat-minutes" class="text-yellow-400">0</span> min</h2>
                <p class="text-xl text-slate-300 mb-6">
                    Do you want to play another ad to stack more minutes?
                </p>
                <div class="flex space-x-4">
                    <button onclick="handleAdRepeatChoice(true)" class="w-1/2 px-6 py-3 bg-yellow-600 text-slate-900 font-bold text-lg rounded-lg hover:bg-yellow-500 transition duration-150 shadow-xl shadow-yellow-500/50">
                        YES
                    </button>
                    <button onclick="handleAdRepeatChoice(false)" class="w-1/2 px-6 py-3 bg-slate-600 text-white font-bold text-lg rounded-lg hover:bg-slate-700 transition duration-150">
                        NO
                    </button>
                </div>
            </div>
        </div>

        <!-- 8. Mock Payment Portal -->
        <div id="payment-portal-container" class="space-y-6 hidden h-full flex items-center justify-center">
             <div class="bg-slate-800 p-10 md:p-16 rounded-xl shadow-2xl max-w-md w-full border-t-4 border-pink-500">
                <h2 class="text-3xl font-bold text-white mb-6 text-center">Premium Subscription</h2>
                <p class="text-lg text-pink-300 mb-8 text-center">
                    Enjoy unlimited, ad-free learning for **₹499 / Month**!
                </p>
                
                <form onsubmit="event.preventDefault(); handleSubscribe();">
                    
                    <!-- Payment Method Tabs/Radios -->
                    <div class="flex space-x-2 mb-6">
                        <input type="radio" id="card" name="paymentMethod" value="Card" checked class="hidden" onchange="updatePaymentInputs()">
                        <label for="card" class="payment-radio-label">Card</label>
                        
                        <input type="radio" id="upi" name="paymentMethod" value="UPI" class="hidden" onchange="updatePaymentInputs()">
                        <label for="upi" class="payment-radio-label">UPI</label>
                        
                        <input type="radio" id="netbanking" name="paymentMethod" value="Net Banking" class="hidden" onchange="updatePaymentInputs()">
                        <label for="netbanking" class="payment-radio-label">Net Banking</label>
                    </div>

                    <!-- Dynamic Input Areas -->
                    
                    <!-- Card Details -->
                    <div id="card-details">
                        <div class="mb-4">
                            <label for="card-number" class="block text-sm font-medium text-slate-400 mb-2">Card Number</label>
                            <input type="text" id="card-number" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-white" placeholder="xxxx xxxx xxxx xxxx" required>
                        </div>
                        <div class="flex space-x-4 mb-6">
                            <div class="w-1/2">
                                <label for="expiry" class="block text-sm font-medium text-slate-400 mb-2">Expiry (MM/YY)</label>
                                <input type="text" id="expiry" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-white" placeholder="01/25" required>
                            </div>
                            <div class="w-1/2">
                                <label for="cvv" class="block text-sm font-medium text-slate-400 mb-2">CVV</label>
                                <input type="text" id="cvv" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-white" placeholder="123" required>
                            </div>
                        </div>
                    </div>

                    <!-- UPI Details -->
                    <div id="upi-details" class="hidden">
                         <div class="mb-4">
                            <label for="upi-id" class="block text-sm font-medium text-slate-400 mb-2">Enter UPI ID</label>
                            <input type="text" id="upi-id" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-white" placeholder="yourname@bankupi" required>
                        </div>
                        <p class="text-sm text-slate-400 mb-6">
                            A payment request will be sent to your UPI app for approval.
                        </p>
                    </div>

                    <!-- Net Banking Details -->
                    <div id="netbanking-details" class="hidden">
                        <div class="mb-4">
                            <label for="bank" class="block text-sm font-medium text-slate-400 mb-2">Select Bank</label>
                            <select id="bank" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-white custom-select" required>
                                <option value="" disabled selected>Choose your bank</option>
                                <option value="SBI">State Bank of India</option>
                                <option value="HDFC">HDFC Bank</option>
                                <option value="ICICI">ICICI Bank</option>
                                <option value="AXIS">Axis Bank</option>
                            </select>
                        </div>
                        <p class="text-sm text-slate-400 mb-6">
                            You will be redirected to your bank's portal for login and payment authorization.
                        </p>
                    </div>
                    
                    <button type="submit" class="w-full px-6 py-3 bg-pink-600 text-white font-bold text-lg rounded-lg hover:bg-pink-700 transition duration-150 shadow-lg shadow-pink-500/30">
                        Subscribe Now
                    </button>
                    <button type="button" onclick="showView('ad-workflow-prompt')" class="w-full mt-4 text-sm text-slate-400 hover:text-indigo-400 transition duration-150">
                        &larr; Cancel
                    </button>
                </form>
            </div>
        </div>

    </main>

</body>
</html>
